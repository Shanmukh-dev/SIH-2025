<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WebRTC Video Call</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#764ba2">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <header class="app-header bg-dark text-white p-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h4 class="mb-0">VideoCall App</h4>
            <div class="user-info">
                <span>Welcome, <strong>{{ user.name }}</strong> ({{ user.mobile }})</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm ms-3">Logout</a>
            </div>
        </div>
    </header>

    <main class="container mt-4">
        <div class="row">
            <!-- Dialer, History, Contacts Panel -->
            <div class="col-lg-4">
                <div class="card main-panel">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="main-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="dialer-tab" data-bs-toggle="tab" data-bs-target="#dialer" type="button" role="tab" aria-controls="dialer" aria-selected="true"><span class="material-icons">dialpad</span></button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false"><span class="material-icons">history</span></button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab" aria-controls="contacts" aria-selected="false"><span class="material-icons">contacts</span></button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body tab-content" id="main-tabs-content">
                        <!-- Dialer Tab -->
                        <div class="tab-pane fade show active" id="dialer" role="tabpanel" aria-labelledby="dialer-tab">
                            <input type="text" id="dialer-input" class="form-control form-control-lg text-center mb-3" placeholder="Enter mobile number" readonly>
                            <div class="dialpad">
                                <div class="dialpad-row"><button class="btn">1</button><button class="btn">2</button><button class="btn">3</button></div>
                                <div class="dialpad-row"><button class="btn">4</button><button class="btn">5</button><button class="btn">6</button></div>
                                <div class="dialpad-row"><button class="btn">7</button><button class="btn">8</button><button class="btn">9</button></div>
                                <div class="dialpad-row"><button class="btn">*</button><button class="btn">0</button><button class="btn">#</button></div>
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <button id="backspace-btn" class="btn btn-secondary"><span class="material-icons">backspace</span></button>
                                <button id="call-btn" class="btn btn-success btn-lg flex-grow-1 mx-2"><span class="material-icons">call</span></button>
                            </div>
                        </div>

                        <!-- Call History Tab -->
                        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                            <ul class="list-group" id="call-history-list">
                                <!-- History items will be injected here -->
                            </ul>
                        </div>

                        <!-- Contacts Tab -->
                        <div class="tab-pane fade" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
                             <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#addContactModal">Add New Contact</button>
                            <ul class="list-group" id="contacts-list">
                                <!-- Contact items will be injected here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Call Panel -->
            <div class="col-lg-8">
                <div id="video-call-container" class="video-call-container d-none">
                    <video id="remote-video" autoplay playsinline></video>
                    <video id="local-video" autoplay playsinline muted></video>
                    <div class="call-controls">
                        <button id="mic-btn" class="btn btn-secondary"><span class="material-icons">mic</span></button>
                        <button id="video-btn" class="btn btn-secondary"><span class="material-icons">videocam</span></button>
                        <button id="hangup-btn" class="btn btn-danger"><span class="material-icons">call_end</span></button>
                    </div>
                </div>
                 <div id="placeholder-container" class="placeholder-container">
                    <span class="material-icons display-1 text-muted">ondemand_video</span>
                    <p class="text-muted">Your video call will appear here.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Incoming Call Modal -->
    <div class="modal fade" id="incomingCallModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Incoming Call</h5>
                </div>
                <div class="modal-body text-center">
                    <p id="incoming-call-from" class="fs-4"></p>
                    <p>is calling you...</p>
                </div>
                <div class="modal-footer d-flex justify-content-around">
                    <button id="answer-btn" type="button" class="btn btn-success btn-lg"><span class="material-icons">call</span> Answer</button>
                    <button id="decline-btn" type="button" class="btn btn-danger btn-lg" data-bs-dismiss="modal"><span class="material-icons">call_end</span> Decline</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Contact Modal -->
    <div class="modal fade" id="addContactModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Contact</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-contact-form">
                        <div class="mb-3">
                            <label for="contact-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="contact-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="contact-mobile" class="form-label">Mobile Number</label>
                            <input type="tel" class="form-control" id="contact-mobile" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="save-contact-btn" class="btn btn-primary">Save Contact</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const currentUser = {
            name: "{{ user.name }}",
            mobile: "{{ user.mobile }}"
        };
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='js/serviceworker.js') }}")
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>